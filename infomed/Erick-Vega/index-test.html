<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Infomed | Sistema de ubicación y contacto de emergencia</title>
  <meta name="description" content="Página de emergencia con datos del portador y contactos de emergencia." />
  <link rel="icon" type="image/png" href="./../infomed.svg">

  <style>
    :root{
      --primary-color: #fdf7d2;
      --ink: #1c1f23;
      --muted:#5c6570;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--ink);
      background: var(--primary-color) url('../bg01.jpg') no-repeat center center/cover;
      background-attachment: fixed; /* fondo estático */
    }
    .wrap{max-width:1200px;margin:0 auto;padding:28px 16px}
    h1,h2{margin:0 0 10px}
    p{margin:0 0 10px; color:var(--muted)}

    .section{
      display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin:18px 0;
      padding:0; /* el vidrio está en las cards, no aquí */
    }

    /* Cards principales (foto, datos, condiciones) con efecto vidrio + borde */
    .card{
      background-color: rgba(255,255,255,.5);
      backdrop-filter: blur(5px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px; width:min(100%,720px);
      border:1px solid #ffffff; /* borde blanco */
    }

    /* Tarjetas de contacto con efecto vidrio + borde */
    .contact-card{
      background-color: rgba(255,255,255,.5);
      backdrop-filter: blur(5px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid #ffffff; /* borde blanco */
      padding:16px; display:flex; flex-direction:column; gap:12px;
    }

    .center{text-align:center}
    .muted{color:var(--muted)}
    .grid{display:flex; flex-wrap:wrap; gap:18px; justify-content:center;}

    .photo{
      display:flex; align-items:center; justify-content:center;
      border-radius:14px; overflow:hidden;
      width:100%;
      aspect-ratio: 1 / 1; /* cuadrado fijo */
      background:#eef1f5;
    }
    .photo img{
      width:100%;
      height:100%;
      object-fit: cover; /* recorte */
    }

    .stack{display:flex; flex-direction:column; gap:10px}
    label{font-size:.92rem; color:var(--muted)}
    input[type="text"], input[type="tel"]{
      width:100%; padding:10px 12px; border:1px solid #dfe3e8; border-radius:12px; outline:none;
      font-size:1rem; background:#fff;
    }
    input[readonly]{ background:#fafbfc; color:#3b3f45; }

    .contact-title{font-weight:700}

    .btns{display:flex; flex-direction:column; gap:18px; align-items:center}
    .btn.icon-only{background:none; border:none; padding:0; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;}
    .ico{width:100px; height:100px; display:inline-block}

    .hr{height:1px; background:#eceff3; margin:8px 0 4px}

    /* Responsivo: 80% en móvil, 30% en escritorio */
    @media (min-width: 992px){
      .sec1 .col{width:30%}
      .sec2 .contact-card{width:30%}
      .sec3 .col{width:30%}
    }
    @media (max-width: 991px){
      .sec1 .col, .sec2 .contact-card, .sec3 .col{width:80%}
    }

    /* Fila de logo (ancho completo y centrado) */
    .row-full{width:100%}
    .infomed-logo{
      display:block; margin:0 auto 20px auto; width:80%; max-width:720px; height:auto;
    }
    @media (min-width:992px){ .infomed-logo{ width:40%; max-width:none; } }

    /* Logo pequeño dentro del card de datos (fila 2) */
    .infomed-logo-inline{display:block; margin:0 auto 10px auto; width:220px; height:auto;}
    @media (min-width:992px){ .infomed-logo-inline{ width:200px; } }

    .mini-label{ font-weight:600; color:#333; text-align:center; margin:8px 0 2px }

    /* Disclaimer */
    .disclaimer{
      margin-top:24px;
      font-size:.9rem;
      text-align:center;
      color:#333;
      background-color: rgba(255,255,255,.65);
      backdrop-filter: blur(5px);
      border-radius: var(--radius);
      border:1px solid #ffffff;
      padding:12px 18px;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Sección 1: fila 1 (logo) + fila 2 (foto | datos) -->
    <section class="section sec1">
      <div class="row-full center">
        <img class="infomed-logo" src="./../infomed.svg" alt="Infomed | Emergency Contacts.">
		<p class="center"><h1>Información vital en el momento preciso.</h1></p>
      </div>

      <div class="card col">
        <div class="photo">
          <img id="fotoPersona" src="./Erick-Vega.png" alt="Fotografía de la persona (portador)">
        </div>
      </div>

      <div class="card col">
        <img class="infomed-logo-inline" src="./../infomed.svg" alt="Infomed | Emergency Contacts.">
        <p class="center">Sistema de ubicación y contacto de emergencia.</p>
        <div class="hr"></div>
        <div class="stack">
          <label for="nombrePersona">Nombre de la persona</label>
          <input id="nombrePersona" type="text" placeholder="Erick Vega Zúñiga" readonly />
          <label for="idPersona">Cédula / Pasaporte</label>
          <input id="idPersona" type="text" placeholder="Ced: 108170227" readonly />
        </div>
        <div style="margin-top:12px">
          <!-- ARREGLO: un solo <p>, sin anidar otro <p> dentro -->
          <p class="muted">Informe a los contactos de emergencia por:<br>- Llamada telefónica<br>- WhatsApp<br>y envíe la ubicación desde el botón.</p>
        </div>
      </div>
    </section>

    <!-- Sección 2: 3 tarjetas de contacto -->
    <section class="section sec2">
      <div class="grid" style="width:100%">

        <!-- Tarjeta 1 -->
        <article class="contact-card" data-card="1">
          <div class="contact-title">Contacto 1</div>
          <div class="stack">
            <label for="c1_nombre">Nombre y apellido</label>
            <input id="c1_nombre" type="text" readonly />
            <label for="c1_tel">Teléfono</label>
            <input id="c1_tel" type="tel" inputmode="tel" readonly />
          </div>
          <div class="btns">
            <div class="mini-label">Envíe la ubicación geográfica:</div>
            <button class="btn icon-only" data-action="loc" data-card="1" title="Enviar ubicación por WhatsApp">
              <img class="ico" src="../../svgicons/emergency-location.svg" alt="Ubicación">
            </button>

            <div class="mini-label">Toque para enviar WhatsApp:</div>
            <button class="btn icon-only" data-action="wa" data-card="1" title="Enviar WhatsApp">
              <img class="ico" src="../../svgicons/whatsapp.svg" alt="WhatsApp">
            </button>

            <div class="mini-label">Toque para llamar:</div>
            <button class="btn icon-only" data-action="call" data-card="1" title="Llamar por teléfono">
              <img class="ico" src="../../svgicons/telephone.svg" alt="Llamar">
            </button>
          </div>
        </article>

        <!-- Tarjeta 2 -->
        <article class="contact-card" data-card="2">
          <div class="contact-title">Contacto 2</div>
          <div class="stack">
            <label for="c2_nombre">Nombre y apellido</label>
            <input id="c2_nombre" type="text" readonly />
            <label for="c2_tel">Teléfono</label>
            <input id="c2_tel" type="tel" inputmode="tel" readonly />
          </div>
          <div class="btns">
            <div class="mini-label">Envíe la ubicación geográfica:</div>
            <button class="btn icon-only" data-action="loc" data-card="2" title="Enviar ubicación por WhatsApp">
              <img class="ico" src="../../svgicons/emergency-location.svg" alt="Ubicación">
            </button>

            <div class="mini-label">Toque para enviar WhatsApp:</div>
            <button class="btn icon-only" data-action="wa" data-card="2" title="Enviar WhatsApp">
              <img class="ico" src="../../svgicons/whatsapp.svg" alt="WhatsApp">
            </button>

            <div class="mini-label">Toque para llamar:</div>
            <button class="btn icon-only" data-action="call" data-card="2" title="Llamar por teléfono">
              <img class="ico" src="../../svgicons/telephone.svg" alt="Llamar">
            </button>
          </div>
        </article>

        <!-- Tarjeta 3 -->
        <article class="contact-card" data-card="3">
          <div class="contact-title">Contacto 3</div>
          <div class="stack">
            <label for="c3_nombre">Nombre y apellido</label>
            <input id="c3_nombre" type="text" readonly />
            <label for="c3_tel">Teléfono</label>
            <input id="c3_tel" type="tel" inputmode="tel" readonly />
          </div>
          <div class="btns">
            <div class="mini-label">Envíe la ubicación geográfica:</div>
            <button class="btn icon-only" data-action="loc" data-card="3" title="Enviar ubicación por WhatsApp">
              <img class="ico" src="../../svgicons/emergency-location.svg" alt="Ubicación">
            </button>

            <div class="mini-label">Toque para enviar WhatsApp:</div>
            <button class="btn icon-only" data-action="wa" data-card="3" title="Enviar WhatsApp">
              <img class="ico" src="../../svgicons/whatsapp.svg" alt="WhatsApp">
            </button>

            <div class="mini-label">Toque para llamar:</div>
            <button class="btn icon-only" data-action="call" data-card="3" title="Llamar por teléfono">
              <img class="ico" src="../../svgicons/telephone.svg" alt="Llamar">
            </button>
          </div>
        </article>

      </div>
    </section>

    <!-- Sección 3: Condiciones especiales (dinámico desde JSON) -->
    <section class="section sec3">
      <div class="card col">
        <h2 class="center">Condiciones Especiales</h2>
        <div class="hr"></div>
        <div id="condiciones" class="stack">
          <!-- Se rellena por JS con los datos del JSON -->
        </div>
      </div>
    </section>

    <!-- Disclaimer -->
    <div class="disclaimer">
      ⚠️ Esta página de contactos de emergencia puede solicitar acceso a su ubicación geográfica para enviarla a los contactos registrados en caso de emergencia.
    </div>

  </div>

  <!-- ===== Config embebida (edita aquí tus datos) ===== -->
  <script type="application/json" id="config">
  {
    "fotoUrl": "./Erick-Vega.png",
    "nombrePersona": "Erick Vega Zúñiga",
    "idPersona": "Ced: 108170227",
    "contactos": [
      { "nombre": "Jorling Oporta", "tel": "86893803" },
      { "nombre": "Damaris Zúñiga", "tel": "88694267" },
      { "nombre": "Claire de Mezerville", "tel": "87022841" }
    ],
    "conditions": {
      "diagnostico_principal": "Cardiópata con Reemplazo Valvular - SJD",
      "anticoagulado": "Sí",
      "mets": "15",
      "alergias": "Ninguna",
      "tipo_sangre": "A+",
      "donante_organos": "No",
      "notas_adicionales": ""
    }
  }
  </script>

  <!-- ===== Lógica JS: carga de datos + botones ===== -->
  <script>
    /* ---------- Utilidades ---------- */
    function encodeTxt(s){ return encodeURIComponent(s || ""); }

    // Normaliza teléfonos para WhatsApp: deja solo dígitos; si son 8 dígitos -> asume Costa Rica (506)
    function normalizePhoneForWhatsApp(raw){
      if(!raw) return "";
      const digits = String(raw).replace(/\D+/g, "");
      if(digits.length === 8){ return "506" + digits; } // CR
      return digits;
    }

    function telHref(raw){
      const digits = String(raw).replace(/\D+/g, "");
      if(!digits) return "";
      if(String(raw).trim().startsWith("+")) return "tel:+" + digits;
      return digits.length === 8 ? "tel:+506" + digits : "tel:+" + digits;
    }

    function getNombrePersona(){
      return document.getElementById("nombrePersona").value.trim() || "la persona";
    }

    function getTelFromCard(n){
      const el = document.getElementById(`c${n}_tel`);
      return el ? el.value.trim() : "";
    }

    function openWhatsApp(phoneDigits, text){
      if(!phoneDigits){ alert("Por favor defina el teléfono del contacto en la configuración."); return; }
      const url = `https://wa.me/${phoneDigits}?text=${encodeTxt(text)}`;
      window.open(url, "_blank");
    }

    /* ---------- Acciones de botones ---------- */
    function handleEnviarUbicacion(n){
      const nombrePersona = getNombrePersona();
      const rawPhone = getTelFromCard(n);
      const phoneDigits = normalizePhoneForWhatsApp(rawPhone);
      if(!phoneDigits){ alert("Por favor defina el teléfono del contacto en la configuración."); return; }

      const fallback = () => {
        const msg = `Enviaré la ubicación de ${nombrePersona}, ya que es una emergencia. Por favor comparta su ubicación aquí.`;
        openWhatsApp(phoneDigits, msg);
      };

      if(!("geolocation" in navigator)){ fallback(); return; }
      const opts = { enableHighAccuracy:true, timeout: 10000, maximumAge: 0 };

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          const googleMapsLink = `https://www.google.com/maps?q=${latitude},${longitude}`;
          const msg = `Enviaré la ubicación de ${nombrePersona}, ya que es una emergencia: ${googleMapsLink}`;
          openWhatsApp(phoneDigits, msg);
        },
        _err => fallback(),
        opts
      );
    }

    function handleWhatsapp(n){
      const nombrePersona = getNombrePersona();
      const rawPhone = getTelFromCard(n);
      const phoneDigits = normalizePhoneForWhatsApp(rawPhone);
      if(!phoneDigits){ alert("Por favor defina el teléfono del contacto en la configuración."); return; }

      const msg =
        `Usted está reportando una emergencia de ${nombrePersona} ` +
        `portador del brazalete Infomed.\n` +
        `Por favor adjunte en este mensaje su localización geográfica.\n` +
        `Ingrese su nombre (opcional):`;
      openWhatsApp(phoneDigits, msg);
    }

    function handleCall(n){
      const rawPhone = getTelFromCard(n);
      const href = telHref(rawPhone);
      if(!href){ alert("Por favor defina el teléfono del contacto en la configuración."); return; }
      window.location.href = href;
    }

    // Delegación de eventos para todos los botones
    document.addEventListener("click", (ev)=>{
      const t = ev.target.closest("[data-action]");
      if(!t) return;
      const action = t.getAttribute("data-action");
      const card = t.getAttribute("data-card");
      if(!card) return;

      if(action === "loc"){ handleEnviarUbicacion(card); }
      else if(action === "wa"){ handleWhatsapp(card); }
      else if(action === "call"){ handleCall(card); }
    });

    /* ---------- Pintar Condiciones Especiales ---------- */
    function addCondLine(container, label, value, blockStyle=false){
      if (!value) return;
      const p = document.createElement('p');
      if (blockStyle) {
        p.innerHTML = `<b>${label}:</b><br>${value}`;
      } else {
        p.innerHTML = `${label ? `<b>${label}:</b> ` : ''}${value}`;
      }
      container.appendChild(p);
    }

    function renderCondiciones(conditions){
      const box = document.getElementById('condiciones');
      if (!box) return;
      box.innerHTML = ''; // limpia

      if (!conditions || typeof conditions !== 'object') {
        addCondLine(box, '', 'Sin datos de condiciones especiales.');
        return;
      }

      // Diagnóstico principal en negrita (línea separada)
      if (conditions.diagnostico_principal) {
        const p = document.createElement('p');
        p.innerHTML = `<b>${conditions.diagnostico_principal}</b>`;
        box.appendChild(p);
      }

      // Líneas simples
      addCondLine(box, '', conditions.anticoagulado ? `Anticoagulado: ${conditions.anticoagulado}` : '');
      addCondLine(box, '', conditions.mets ? `Mets ${conditions.mets}` : '');

      // Bloques con etiqueta + salto de línea (como tu diseño original)
      addCondLine(box, 'Alergias', conditions.alergias, true);
      addCondLine(box, 'Tipo de sangre', conditions.tipo_sangre, true);
      addCondLine(box, 'Registrado como donante de órganos', conditions.donante_organos, true);

      if (conditions.notas_adicionales) {
        addCondLine(box, 'Notas adicionales', conditions.notas_adicionales, true);
      }
    }

    /* ---------- Carga de configuración (JSON embebido) ---------- */
    function applyConfig(cfg){
      // Foto
      const img = document.getElementById("fotoPersona");
      if(img && cfg.fotoUrl){ img.src = cfg.fotoUrl; }

      // Persona
      const nombre = document.getElementById("nombrePersona");
      const idp = document.getElementById("idPersona");
      if(nombre) nombre.value = cfg.nombrePersona || "";
      if(idp) idp.value = cfg.idPersona || "";

      // Contactos
      const contactos = Array.isArray(cfg.contactos) ? cfg.contactos : [];
      contactos.slice(0,3).forEach((c, i)=>{
        const n = i+1;
        const elNom = document.getElementById(`c${n}_nombre`);
        const elTel = document.getElementById(`c${n}_tel`);
        if(elNom) elNom.value = (c.nombre || "");
        if(elTel) elTel.value = (c.tel || "");
      });

      // Condiciones especiales
      renderCondiciones(cfg.conditions);
    }

    // ARREGLO: inicializar cuando el DOM esté listo
    window.addEventListener('DOMContentLoaded', () => {
      try{
        const el = document.getElementById("config");
        const raw = el ? el.textContent : "{}";
        const cfg = JSON.parse(raw || "{}");
        applyConfig(cfg);
      }catch(e){
        console.error("Config embebida inválida", e);
      }
    });
  </script>
</body>
</html>
