<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invitación de boda</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f8f8f5;
      color: #222;
    }
    .hero {
      text-align: center;
      padding: 40px 20px;
    }
    .hero h1 {
      font-family: 'Great Vibes', cursive;
      font-size: clamp(28px, 6vw, 64px);
      margin: 0;
      color: #333;
    }
    .hero .date {
      margin-top: 10px;
      font-size: 18px;
      color: #555;
    }
    .countdown {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }
    .countdown .unit {
      background: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      text-align: center;
    }
    .section {
      background: #fff;
      margin: 20px auto;
      padding: 30px;
      border-radius: 16px;
      max-width: 600px;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .section h2 {
      text-align: center;
      font-family: 'Great Vibes', cursive;
      font-size: 32px;
      margin: 0 0 20px;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    select, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 5px 0;
    }
    button {
      background: #f5f5f5;
      cursor: pointer;
    }
    button:hover {
      background: #eee;
    }
    .help.center {
      text-align: center;
    }
    /* Mensaje de confirmación prominente y centrado */
    #rsvp-msg.success {
      color: #1d6b32;
      font-weight: 800;
      font-size: clamp(16px, 2.8vw, 20px);
      background: #e7f5eb;
      border: 1px solid #bfe3c8;
      padding: 10px 14px;
      border-radius: 10px;
      display: inline-block;
      margin: 15px auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1 id="names">Marta & Oscar</h1>
    <div class="date muted" id="date-readable">25 de octubre de 2025 • 10:00 a. m.</div>
  </div>

  <div class="countdown" id="countdown"></div>

  <div class="section" id="rsvp-section">
    <h2>Confirmar Asistencia</h2>
    <p>Por favor confirma antes del <span id="deadline"></span>.</p>
    <p id="rsvp-greeting"></p>
    <form id="rsvp-form">
      <label for="acompanantes">Acompañantes:</label>
      <select id="acompanantes"></select>
      <p id="total"></p>
      <button type="submit">Confirmar asistencia</button>
      <a id="wab" href="#" target="_blank" style="display:none; margin-left:10px;">Avisar por WhatsApp</a>
    </form>
    <p class="help center" id="rsvp-msg"></p>
  </div>

  <script>
    async function loadConfig() {
      const res = await fetch('config.json');
      const config = await res.json();

      // nombres y fecha
      document.getElementById('names').textContent = config.names.join(' & ');

      // Fecha bonita desde ISO
      const fecha = new Date(config.date.iso);
      const opciones = { day:'numeric', month:'long', year:'numeric', hour:'numeric', minute:'2-digit' };
      const fechaBonita = fecha.toLocaleDateString('es-ES', opciones);
      document.getElementById('date-readable').textContent = fechaBonita;

      // Countdown
      function updateCountdown() {
        const now = new Date();
        const diff = fecha - now;
        const cd = document.getElementById('countdown');
        if (diff <= 0) {
          cd.textContent = '¡Hoy es el gran día!';
          return;
        }
        const d = Math.floor(diff / (1000*60*60*24));
        const h = Math.floor((diff / (1000*60*60)) % 24);
        const m = Math.floor((diff / (1000*60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        cd.innerHTML = `
          <div class="unit"><div>${d}</div><small>Días</small></div>
          <div class="unit"><div>${h}</div><small>Horas</small></div>
          <div class="unit"><div>${m}</div><small>Minutos</small></div>
          <div class="unit"><div>${s}</div><small>Segundos</small></div>
        `;
      }
      updateCountdown();
      setInterval(updateCountdown, 1000);

      // RSVP deadline
      const deadlineDate = new Date(config.rsvp.deadline);
      const fechaLimite = deadlineDate.toLocaleDateString('es-ES', { day:'numeric', month:'long', year:'numeric' });
      document.getElementById('deadline').textContent = fechaLimite;

      // Lookup invitado por token
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('t');
      if (!token) return;
      const EP = config.rsvp.endpoint;
      const msg = document.getElementById('rsvp-msg');
      const form = document.getElementById('rsvp-form');
      const sel = document.getElementById('acompanantes');
      const total = document.getElementById('total');
      const wab = document.getElementById('wab');

      fetch(EP + '?action=lookup&token=' + encodeURIComponent(token))
        .then(r => r.json())
        .then(rsvp => {
          if (!rsvp.ok) {
            msg.textContent = 'Invitado no válido.';
            return;
          }
          document.getElementById('rsvp-greeting').textContent = 'Hola ' + rsvp.nombre + '. Confirma el número de asistentes incluyéndote.';
          sel.innerHTML = '';
          for (let i=0;i<=rsvp.allowed_max;i++) {
            const o=document.createElement('option');
            o.value=i;
            o.textContent=i;
            sel.appendChild(o);
          }
          sel.value=rsvp.acomp_prev!==null?rsvp.acomp_prev:0;
          total.textContent='Total de personas: ' + (Number(sel.value)+1);
        });

      sel.addEventListener('change', ()=>{
        total.textContent='Total de personas: ' + (Number(sel.value)+1);
      });

      // Confirmación
      form.addEventListener('submit', function(ev){
        ev.preventDefault();
        msg.textContent='Enviando…';
        msg.classList.remove('success');

        const p = new URLSearchParams({ action:'confirm', token:token, acompanantes: sel.value });
        fetch(EP, { method:'POST', body:p })
          .then(r=>r.json())
          .then(j=>{
            if (!j.ok) {
              msg.textContent='Error: ' + (j.error||'No se pudo confirmar');
              return;
            }
            const acomp = Number(sel.value);
            let uiText = '';
            if (acomp === 0)       uiText = 'Confirmaste tu asistencia.';
            else if (acomp === 1)  uiText = 'Confirmaste tu asistencia y la de 1 invitado.';
            else                   uiText = 'Confirmaste tu asistencia y la de ' + acomp + ' invitados.';

            msg.textContent = uiText;
            msg.classList.add('success');
            msg.scrollIntoView({behavior:'smooth', block:'center'});

            sel.innerHTML='';
            for (let i=0;i<=acomp;i++){
              const o=document.createElement('option');
              o.value=String(i); o.textContent=String(i);
              sel.appendChild(o);
            }
            sel.value=String(acomp);
            total.textContent='Total de personas: ' + (acomp+1);
          })
          .catch(()=>{
            msg.textContent='Error de red. Intenta de nuevo.';
          });
      });
    }
    loadConfig();
  </script>
</body>
</html>
