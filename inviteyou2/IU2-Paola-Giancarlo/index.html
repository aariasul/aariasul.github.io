<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invitación de boda — Paola & Giancarlo</title>
  <meta name="description" content="Acompáñanos a celebrar nuestra boda. Paola & Giancarlo — 25 de octubre de 2025." />

  <!-- Open Graph -->
  <meta property="og:title" content="Invitación de boda — Paola & Giancarlo" />
  <meta property="og:description" content="Acompáñanos a celebrar nuestra boda. 25 de octubre de 2025." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="img/couple-hero.jpg" />
  <meta property="og:locale" content="es_CR" />

  <link rel="icon" href="img/couple-logo.svg" type="image/svg+xml">

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&family=Quicksand:wght@300;400;600&display=swap" rel="stylesheet" />

  <!-- Loader de configuración -->
  <script src="config-loader.js" defer></script>

  <style>
    :root{
      --bg: rgb(243,242,238);
      --card: rgb(251,250,248);
      --ink: #2a2a2a;
      --muted: #696969;
      --accent: rgba(0,0,0,0.08);
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius: 15px;
      --radius-lg: 25px;
      --ease: cubic-bezier(.16,1,.3,1);
      --brand-ink: #1f2937;
      --title: "Pinyon Script", cursive;
      --base: "Quicksand", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --names-start-offset: 60%;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--base);line-height:1.6;}
    .wrap{ width: 80%; max-width: 960px; margin: 0 auto; padding: 24px 0 64px; }
    h1,h2,h3,.script{font-family:var(--title);font-weight:400;}
    .muted{color:var(--muted);}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;margin:28px auto;}
    .center{text-align:center;}
    .btn{display:inline-block;background:var(--bg);color:var(--ink);border-radius:var(--radius-lg);padding:12px 18px;text-decoration:none;box-shadow:var(--shadow);border:1px solid var(--accent);font-weight:600;cursor:pointer;}
    .logo{ width:100px;height:100px;display:block;margin:24px auto 10px; }
    .hero{position:relative;margin:12px auto 8px;width:min(90%,1200px);border-radius:18px;overflow:hidden;box-shadow:var(--shadow);}
    .hero img{width:100%;height:auto;display:block;}
    .hero .names{position:absolute;inset:0;display:grid;place-items:center;text-align:center;}
    .hero .names .script{color:#fbfaf8;text-shadow:0 3px 10px rgba(0,0,0,1);}
    .date{text-align:center;font-size:18px;margin-top:8px;}
    .countdown{display:grid;grid-template-columns:repeat(4,minmax(60px,1fr));gap:12px;margin-top:16px;}
    .cd-box{text-align:center;background:#fff;border-radius:12px;padding:12px;border:1px solid var(--accent);box-shadow:var(--shadow);}
    .cd-num{font-size:28px;font-weight:700;}
    .cd-label{font-size:12px;color:var(--muted);}
    #rsvp-note{font-size:18px;font-weight:700;color:var(--brand-ink);text-align:center;margin:10px auto 14px;}
    #rsvpSelect{display:block;width:100%;max-width:50%;margin:0 auto;padding:12px 14px;font-size:20px;font-weight:700;text-align:center;}
    #rsvp-total{text-align:center;margin-top:8px;font-size:18px;font-weight:700;}
    /* NUEVO: estilo mensaje de confirmación exitoso */
    #rsvp-msg.success{
      color:#1d6b32;
      font-weight:800;
      font-size:20px;
      background:#e7f5eb;
      border:1px solid #bfe3c8;
      padding:10px 14px;
      border-radius:10px;
      display:inline-block;
    }
  </style>
</head>
<body>

  <main class="wrap" id="top">
    <!-- Logo -->
    <img class="logo" src="img/couple-logo.svg" alt="Logo de la pareja" />

    <!-- Hero -->
    <section class="hero" id="hero">
      <img src="img/couple-hero.jpg" alt="Foto principal" />
      <div class="names"><div class="script">Paola &amp; Giancarlo</div></div>
    </section>

    <!-- Fecha encabezado autogenerada -->
    <div class="date muted" id="hero-date">—</div>

    <!-- Countdown -->
    <section class="card">
      <div class="center">
        <p>Nos llena de alegría invitarte a compartir este día tan especial.</p>
        <div class="countdown" id="countdown">
          <div class="cd-box"><div class="cd-num" id="cd-days">0</div><div class="cd-label">Días</div></div>
          <div class="cd-box"><div class="cd-num" id="cd-hours">0</div><div class="cd-label">Horas</div></div>
          <div class="cd-box"><div class="cd-num" id="cd-mins">0</div><div class="cd-label">Minutos</div></div>
          <div class="cd-box"><div class="cd-num" id="cd-secs">0</div><div class="cd-label">Segundos</div></div>
        </div>
      </div>
    </section>

    <!-- RSVP -->
    <section class="card" id="rsvp">
      <div class="center">
        <h2>Confirmar Asistencia</h2>
        <p class="muted" id="rsvp-deadline">Por favor confirma antes del <strong>—</strong>.</p>
        <p id="rsvp-note">Cargando…</p>
      </div>

      <form id="rsvp-form" class="form" style="display:none">
        <div class="field">
          <label for="rsvpSelect"><strong>Acompañantes</strong>:</label>
          <select id="rsvpSelect" name="acompanantes"></select>
          <span id="rsvp-total">Total de personas: 1</span>
        </div>
        <div class="center" style="margin-top:6px;">
          <button class="btn" type="submit">Confirmar asistencia</button>
          <a id="wa-btn" class="btn" target="_blank" rel="noopener" style="display:none">Avisar por WhatsApp</a>
        </div>
        <p class="center" id="rsvp-msg" style="margin-top:8px;"></p>
      </form>
    </section>
  </main>

  <!-- Scripts -->
  <script>
    const CFG = window.RUNTIME_CONFIG || {};
    const WEDDING_DATE_ISO = CFG.date?.iso ?? "2025-10-25T10:00:00-06:00";

    // Fecha encabezado desde date.iso
    (function(){
      const out = document.getElementById('hero-date');
      try {
        const d = new Date(WEDDING_DATE_ISO);
        const fecha = d.toLocaleDateString('es-CR',{day:'numeric',month:'long',year:'numeric'});
        const hora  = d.toLocaleTimeString('es-CR',{hour:'numeric',minute:'2-digit'});
        out.textContent = `${fecha} • ${hora}`;
      }catch{out.textContent='—';}
    })();

    // Countdown
    (function(){
      const end = new Date(WEDDING_DATE_ISO).getTime();
      const elDays=document.getElementById('cd-days');
      const elHours=document.getElementById('cd-hours');
      const elMins=document.getElementById('cd-mins');
      const elSecs=document.getElementById('cd-secs');
      function update(){
        const diff=Math.max(0,end-Date.now());
        const s=Math.floor(diff/1000);
        elDays.textContent=Math.floor(s/86400);
        elHours.textContent=String(Math.floor((s%86400)/3600)).padStart(2,'0');
        elMins.textContent=String(Math.floor((s%3600)/60)).padStart(2,'0');
        elSecs.textContent=String(s%60).padStart(2,'0');
      }
      update(); setInterval(update,1000);
    })();
  </script>

  <!-- RSVP -->
  <script>
  (function(){
    function $(s){return document.querySelector(s);}
    function int(v,d){v=Number(v);return isFinite(v)?v:d;}
    function qs(k){return new URLSearchParams(location.search).get(k);}
    function digits(s){return String(s||'').replace(/\D+/g,'');}
    function whenConfig(cb){let tries=80,iv=setInterval(function(){if(window.config||tries--<=0){clearInterval(iv);cb(window.config||{});}},50);}

    whenConfig(function(cfg){
      const rsvp=(cfg&&cfg.rsvp)||{};
      const note=$('#rsvp-note');
      const form=$('#rsvp-form');
      const sel=$('#rsvpSelect');
      const total=$('#rsvp-total');
      const msg=$('#rsvp-msg');
      const wab=$('#wa-btn');

      // Deadline
      try{
        const dl=rsvp.deadline||'';
        if(dl){
          let fechaTxt=dl;
          if(/^\d{4}-\d{2}-\d{2}$/.test(dl)){
            const d=new Date(dl+"T00:00:00");
            const f=d.toLocaleDateString('es-ES',{day:'numeric',month:'long'});
            fechaTxt=f+', '+d.getFullYear();
          }
          $('#rsvp-deadline').innerHTML='Por favor confirma antes del <strong>'+fechaTxt+'</strong>.';
        }
      }catch{}

      const EP=rsvp.endpoint; const token=qs('t')||'';
      if(!EP){note.textContent='RSVP no configurado.';return;}
      if(!token){note.textContent='Usa tu enlace personal (incluye token).';return;}

      // Lookup
      fetch(EP+'?action=lookup&token='+encodeURIComponent(token))
      .then(r=>r.json())
      .then(data=>{
        if(!data.ok){note.textContent='Token no válido.';return;}
        const nombre=data.nombre||'invitado/a';
        const allowedMax=int(data.allowed_max,0);
        const acompPrev=data.acomp_prev==null?null:int(data.acomp_prev,0);

        note.textContent='Hola '+nombre+'. Confirma el número de asistentes incluyéndote.';
        sel.innerHTML='';
        for(let i=0;i<=allowedMax;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);sel.appendChild(o);}
        sel.value=String(acompPrev!=null?acompPrev:allowedMax);
        total.textContent='Total de personas: '+(Number(sel.value)+1);
        form.style.display='block';

        sel.addEventListener('change',()=>{total.textContent='Total de personas: '+(Number(sel.value)+1);});

        // Confirm
        form.addEventListener('submit',function(ev){
          ev.preventDefault();
          msg.textContent='Enviando…';
          msg.classList.remove('success');
          const p=new URLSearchParams({action:'confirm',token:token,acompanantes:sel.value});
          fetch(EP,{method:'POST',body:p})
          .then(r=>r.json())
          .then(j=>{
            if(!j.ok){msg.textContent='Error: '+(j.error||'No se pudo confirmar');return;}
            const acomp=Number(sel.value);
            let uiText='';
            if(acomp===0) uiText='Confirmaste tu asistencia.';
            else if(acomp===1) uiText='Confirmaste tu asistencia y la de 1 invitado.';
            else uiText='Confirmaste tu asistencia y la de '+acomp+' invitados.';
            msg.textContent=uiText;
            msg.classList.add('success');

            sel.innerHTML='';
            for(let i=0;i<=acomp;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);sel.appendChild(o);}
            sel.value=String(acomp);
            total.textContent='Total de personas: '+(acomp+1);

            if(rsvp.phone){
              const phone=digits(rsvp.phone);
              wab.href='https://wa.me/'+phone+'?text='+encodeURIComponent(uiText);
              wab.style.display='inline-block';
            }
            msg.scrollIntoView({behavior:'smooth',block:'center'});
          })
          .catch(()=>{msg.textContent='Error de red. Intenta de nuevo.';});
        });
      })
      .catch(()=>{note.textContent='No se pudo consultar el cupo (red).';});
    });
  })();
  </script>
</body>
</html>
